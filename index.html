<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fimas Sport - Результаты соревнований</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: #1a237e;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2rem;
        }

        .admin-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-btn:hover {
            background-color: #f57c00;
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-form {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        main {
            padding: 2rem 0;
            min-height: 60vh;
        }

        h2 {
            margin-bottom: 1.5rem;
            color: #1a237e;
        }

        .list-item {
            background-color: white;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item a {
            text-decoration: none;
            color: #1a237e;
            font-weight: bold;
            flex-grow: 1;
            cursor: pointer;
        }

        .list-item a:hover {
            text-decoration: underline;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-edit {
            background-color: #4caf50;
            color: white;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-add {
            background-color: #2196f3;
            color: white;
            margin-bottom: 1rem;
        }

        .btn-complete {
            background-color: #9c27b0;
            color: white;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #1a237e;
            color: white;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .add-form {
            background-color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .add-form input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .admin-btn {
                margin-top: 1rem;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .admin-controls {
                margin-top: 0.5rem;
                align-self: flex-end;
            }
            
            table {
                font-size: 0.9rem;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4caf50;
            color: white;
            border-radius: 4px;
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a237e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            background-color: #1a237e;
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-top: 2rem;
        }

        .config-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .token-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }

        .admin-only {
            display: none;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <header>
        <div class="container header-content">
            <h1><a href="#" style="color: white; text-decoration: none;" onclick="navigateTo('')">Fimas Sport</a></h1>
            <button class="admin-btn" id="adminBtn">Войти в режим администратора</button>
        </div>
    </header>

    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>Вход для администратора</h2>
            <div class="form-group">
                <label for="login">Логин:</label>
                <input type="text" id="login" placeholder="Введите логин">
            </div>
            <div class="form-group">
                <label for="password">Пароль:</label>
                <input type="password" id="password" placeholder="Введите пароль">
            </div>
            <div class="form-buttons">
                <button class="btn" id="loginCancel">Отмена</button>
                <button class="btn admin-btn" id="loginSubmit">Войти</button>
            </div>
        </div>
    </div>

    <div class="login-modal" id="configModal">
        <div class="login-form">
            <h2>Настройки GitHub API</h2>
            
            <div class="token-instructions">
                <strong>Как создать токен:</strong>
                <ol>
                    <li>Зайдите в GitHub Settings → Developer settings → Fine-grained tokens</li>
                    <li>Создайте новый токен с правами доступа к репозиторию</li>
                    <li>Выберите только этот репозиторий</li>
                    <li>Установите разрешения: Contents - Read and write</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="repoOwner">Владелец репозитория:</label>
                <input type="text" id="repoOwner" placeholder="Ваш username на GitHub">
            </div>
            <div class="form-group">
                <label for="repoName">Название репозитория:</label>
                <input type="text" id="repoName" placeholder="Название репозитория">
            </div>
            <div class="form-group">
                <label for="githubToken">GitHub Fine-grained Token:</label>
                <input type="password" id="githubToken" placeholder="github_pat_...">
                <small style="color: #666;">Требуется для записи данных</small>
            </div>
            <div class="form-buttons">
                <button class="btn" id="configCancel">Отмена</button>
                <button class="btn admin-btn" id="configSave">Сохранить</button>
            </div>
        </div>
    </div>

    <main class="container">
        <div class="spinner" id="loadingSpinner"></div>
        <div id="content"></div>
    </main>

    <footer>
        <div class="container">
            <p>Fimas Sport &copy; 2023. Все права защищены.</p>
            <button class="btn admin-only" id="configButton" onclick="showConfig()" style="margin-top: 10px;">Настройки API</button>
        </div>
    </footer>

    <script>
        const state = {
            isAdmin: false,
            competitions: [],
            currentView: 'competitions',
            currentCompetitionId: null,
            currentRaceId: null,
            config: {
                repoOwner: '',
                repoName: '',
                githubToken: ''
            }
        };

        const adminBtn = document.getElementById('adminBtn');
        const loginModal = document.getElementById('loginModal');
        const loginCancel = document.getElementById('loginCancel');
        const loginSubmit = document.getElementById('loginSubmit');
        const configModal = document.getElementById('configModal');
        const configCancel = document.getElementById('configCancel');
        const configSave = document.getElementById('configSave');
        const contentDiv = document.getElementById('content');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const notification = document.getElementById('notification');
        const configButton = document.getElementById('configButton');

        function initConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                state.config = JSON.parse(savedConfig);
            }
        }

        function saveConfig() {
            state.config.repoOwner = document.getElementById('repoOwner').value;
            state.config.repoName = document.getElementById('repoName').value;
            state.config.githubToken = document.getElementById('githubToken').value;
            
            localStorage.setItem('githubConfig', JSON.stringify(state.config));
            hideConfig();
            showNotification('Настройки сохранены');
            loadData();
        }

        function showConfig() {
            document.getElementById('repoOwner').value = state.config.repoOwner;
            document.getElementById('repoName').value = state.config.repoName;
            document.getElementById('githubToken').value = state.config.githubToken;
            configModal.style.display = 'flex';
        }

        function hideConfig() {
            configModal.style.display = 'none';
        }

        // Функция для обновления видимости элементов для администратора
        function updateAdminVisibility() {
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(element => {
                element.style.display = state.isAdmin ? 'inline-block' : 'none';
            });
        }

        async function loadData() {
            showLoading();
            
            if (!state.config.repoOwner || !state.config.repoName) {
                contentDiv.innerHTML = `
                    <div class="config-form">
                        <h2>Настройте подключение к GitHub</h2>
                        <p>Для работы приложения необходимо указать данные репозитория:</p>
                        <button class="btn admin-btn" onclick="showConfig()">Настроить</button>
                    </div>
                `;
                hideLoading();
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${state.config.repoOwner}/${state.config.repoName}/contents/data.json`
                );
                
                if (response.status === 404) {
                    const defaultData = getDefaultData();
                    await saveDataToGitHub(defaultData);
                    state.competitions = defaultData;
                    showNotification('Созданы начальные данные');
                } else if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content.replace(/\s/g, ''));
                    state.competitions = JSON.parse(content);
                    showNotification('Данные загружены');
                } else {
                    throw new Error('Ошибка загрузки данных');
                }
                
                renderCurrentView();
            } catch (error) {
                console.error('Error loading data:', error);
                contentDiv.innerHTML = `
                    <div class="config-form">
                        <h2>Ошибка загрузки данных</h2>
                        <p>${error.message}</p>
                        <p>Проверьте настройки репозитория.</p>
                        <button class="btn admin-btn" onclick="showConfig()">Проверить настройки</button>
                    </div>
                `;
            }
            
            hideLoading();
        }

        function getDefaultData() {
            return [
                {
                    id: 1,
                    name: "Чемпионат мира по гребле 2023",
                    races: [
                        {
                            id: 1,
                            name: "Одиночки 500м",
                            participants: [
                                { id: 1, number: 101, name: "Иван Петров", time: null, place: null },
                                { id: 2, number: 102, name: "Алексей Смирнов", time: null, place: null }
                            ],
                            completed: false
                        }
                    ]
                }
            ];
        }

        async function saveDataToGitHub(data) {
            if (!state.config.githubToken) {
                showNotification('Токен GitHub не настроен. Данные не сохранены.', true);
                return false;
            }

            showLoading();
            
            try {
                const getResponse = await fetch(
                    `https://api.github.com/repos/${state.config.repoOwner}/${state.config.repoName}/contents/data.json`,
                    {
                        headers: {
                            'Authorization': `Bearer ${state.config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        }
                    }
                );

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                } else if (getResponse.status !== 404) {
                    throw new Error('Не удалось получить информацию о файле');
                }

                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                const response = await fetch(
                    `https://api.github.com/repos/${state.config.repoOwner}/${state.config.repoName}/contents/data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${state.config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify({
                            message: 'Update competition data - ' + new Date().toLocaleString(),
                            content: content,
                            sha: sha
                        })
                    }
                );

                if (response.ok) {
                    showNotification('Данные сохранены на сервере');
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error('GitHub API Error:', errorData);
                    throw new Error(errorData.message || 'Ошибка сохранения данных');
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Ошибка сохранения: ' + error.message, true);
                return false;
            } finally {
                hideLoading();
            }
        }

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#f44336' : '#4caf50';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function showLoading() {
            loadingSpinner.style.display = 'block';
            contentDiv.style.display = 'none';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
            contentDiv.style.display = 'block';
        }

        adminBtn.addEventListener('click', showLoginModal);
        loginCancel.addEventListener('click', hideLoginModal);
        loginSubmit.addEventListener('click', handleLogin);
        configCancel.addEventListener('click', hideConfig);
        configSave.addEventListener('click', saveConfig);

        function init() {
            initConfig();
            
            const savedAdminState = localStorage.getItem('isAdmin');
            if (savedAdminState === 'true') {
                state.isAdmin = true;
                updateAdminUI();
            }
            
            loadData();
            window.addEventListener('hashchange', handleRouting);
        }

        function showLoginModal() {
            if (state.isAdmin) {
                handleLogout();
                return;
            }
            loginModal.style.display = 'flex';
        }

        function hideLoginModal() {
            loginModal.style.display = 'none';
            document.getElementById('login').value = '';
            document.getElementById('password').value = '';
        }

        function handleLogin() {
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            
            if (login === 'canoe' && password === '1111') {
                state.isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                updateAdminUI();
                hideLoginModal();
                showNotification('Вы вошли в режим администратора');
                renderCurrentView();
            } else {
                showNotification('Неверный логин или пароль', true);
            }
        }

        function updateAdminUI() {
            adminBtn.textContent = state.isAdmin 
                ? 'Выйти из режима администратора' 
                : 'Войти в режим администратора';
            
            // Обновляем видимость элементов для администратора
            updateAdminVisibility();
        }

        function handleLogout() {
            state.isAdmin = false;
            localStorage.removeItem('isAdmin');
            updateAdminUI();
            showNotification('Вы вышли из режима администратора');
            renderCurrentView();
        }

        function handleRouting() {
            const hash = window.location.hash;
            
            if (!hash || hash === '#/' || hash === '#') {
                state.currentView = 'competitions';
                renderCompetitionsList();
            } else if (hash.startsWith('#/competition/')) {
                const competitionId = parseInt(hash.split('/')[2]);
                state.currentCompetitionId = competitionId;
                state.currentView = 'competition';
                renderCompetition();
            } else if (hash.startsWith('#/race/')) {
                const parts = hash.split('/');
                const competitionId = parseInt(parts[2]);
                const raceId = parseInt(parts[3]);
                state.currentCompetitionId = competitionId;
                state.currentRaceId = raceId;
                state.currentView = 'race';
                renderRace();
            } else {
                navigateTo('');
            }
        }

        function navigateTo(path) {
            window.location.hash = path;
        }

        function renderCompetitionsList() {
            let html = `<h2>Список соревнований</h2>`;
            
            if (state.isAdmin) {
                html += `
                    <div class="add-form">
                        <input type="text" id="newCompetitionName" placeholder="Название соревнования">
                        <button class="btn btn-add" onclick="addCompetition()">Добавить соревнование</button>
                    </div>
                `;
            }
            
            if (state.competitions.length === 0) {
                html += `<p>Соревнований пока нет.</p>`;
            } else {
                state.competitions.forEach(competition => {
                    html += `
                        <div class="list-item">
                            <a onclick="navigateTo('#/competition/${competition.id}')">${competition.name}</a>
                            ${state.isAdmin ? `
                                <div class="admin-controls">
                                    <button class="btn btn-edit" onclick="event.stopPropagation(); editCompetition(${competition.id})">Редактировать</button>
                                    <button class="btn btn-delete" onclick="event.stopPropagation(); deleteCompetition(${competition.id})">Удалить</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            contentDiv.innerHTML = html;
        }

        function renderCompetition() {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            
            if (!competition) {
                navigateTo('');
                return;
            }
            
            let html = `
                <h2>${competition.name}</h2>
                <button class="btn" onclick="navigateTo('')">← Назад к списку соревнований</button>
            `;
            
            if (state.isAdmin) {
                html += `
                    <div class="add-form">
                        <input type="text" id="newRaceName" placeholder="Название заезда">
                        <button class="btn btn-add" onclick="addRace()">Добавить заезд</button>
                    </div>
                `;
            }
            
            if (!competition.races || competition.races.length === 0) {
                html += `<p>Заездов пока нет.</p>`;
            } else {
                html += `<h3 style="margin-top: 1rem;">Заезды:</h3>`;
                competition.races.forEach(race => {
                    html += `
                        <div class="list-item">
                            <a onclick="navigateTo('#/race/${competition.id}/${race.id}')">${race.name}</a>
                            ${state.isAdmin ? `
                                <div class="admin-controls">
                                    <button class="btn btn-edit" onclick="event.stopPropagation(); editRace(${race.id})">Редактировать</button>
                                    <button class="btn btn-delete" onclick="event.stopPropagation(); deleteRace(${race.id})">Удалить</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            contentDiv.innerHTML = html;
        }

        function renderRace() {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            if (!competition) {
                navigateTo('');
                return;
            }
            
            const race = competition.races.find(r => r.id === state.currentRaceId);
            if (!race) {
                navigateTo(`#/competition/${competition.id}`);
                return;
            }
            
            let html = `
                <h2>${race.name}</h2>
                <p><strong>Соревнование:</strong> ${competition.name}</p>
                <button class="btn" onclick="navigateTo('#/competition/${competition.id}')">← Назад к соревнованию</button>
            `;
            
            if (state.isAdmin) {
                html += `
                    <div class="add-form">
                        <input type="number" id="newParticipantNumber" placeholder="Номер участника">
                        <input type="text" id="newParticipantName" placeholder="Имя и фамилия участника">
                        <button class="btn btn-add" onclick="addParticipant()">Добавить участника</button>
                    </div>
                `;
            }
            
            if (race.completed) {
                html += `<h3 style="margin-top: 1rem;">Результаты заезда:</h3>`;
                html += renderResultsTable(race);
            } else {
                html += `<h3 style="margin-top: 1rem;">Участники:</h3>`;
                
                if (!race.participants || race.participants.length === 0) {
                    html += `<p>Участников пока нет.</p>`;
                } else {
                    html += `
                        <table>
                            <thead>
                                <tr>
                                    <th>Номер</th>
                                    <th>Имя и фамилия</th>
                                    ${state.isAdmin ? '<th>Действия</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    race.participants.forEach(participant => {
                        html += `
                            <tr>
                                <td>${participant.number}</td>
                                <td>${participant.name}</td>
                                ${state.isAdmin ? `
                                    <td>
                                        <button class="btn btn-edit" onclick="editParticipant(${participant.id})">Редактировать</button>
                                        <button class="btn btn-delete" onclick="deleteParticipant(${participant.id})">Удалить</button>
                                    </td>
                                ` : ''}
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table>`;
                }
                
                if (state.isAdmin && race.participants && race.participants.length > 0) {
                    html += `
                        <button class="btn btn-complete" onclick="completeRace()">Завершить заезд</button>
                    `;
                }
            }
            
            contentDiv.innerHTML = html;
        }

        function renderResultsTable(race) {
            const sortedParticipants = [...race.participants].sort((a, b) => {
                if (a.place === null) return 1;
                if (b.place === null) return -1;
                return a.place - b.place;
            });
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Место</th>
                            <th>Номер</th>
                            <th>Имя и фамилия</th>
                            <th>Время</th>
                            ${state.isAdmin ? '<th>Действия</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedParticipants.forEach(participant => {
                html += `
                    <tr>
                        <td>${participant.place || '-'}</td>
                        <td>${participant.number}</td>
                        <td>${participant.name}</td>
                        <td>${participant.time || '-'}</td>
                        ${state.isAdmin ? `
                            <td>
                                <button class="btn btn-edit" onclick="editResult(${participant.id})">Изменить результат</button>
                            </td>
                        ` : ''}
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            if (state.isAdmin) {
                html += `
                    <button class="btn" onclick="reopenRace()">Возобновить заезд</button>
                `;
            }
            
            return html;
        }

        async function addCompetition() {
            const nameInput = document.getElementById('newCompetitionName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('Введите название соревнования', true);
                return;
            }
            
            const newId = state.competitions.length > 0 
                ? Math.max(...state.competitions.map(c => c.id)) + 1 
                : 1;
            
            state.competitions.push({
                id: newId,
                name: name,
                races: []
            });
            
            const success = await saveDataToGitHub(state.competitions);
            if (success) {
                nameInput.value = '';
                renderCompetitionsList();
            }
        }

        async function editCompetition(id) {
            const competition = state.competitions.find(c => c.id === id);
            const newName = prompt('Введите новое название соревнования:', competition.name);
            
            if (newName !== null && newName.trim() !== '') {
                competition.name = newName.trim();
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderCompetitionsList();
                }
            }
        }

        async function deleteCompetition(id) {
            if (confirm('Вы уверены, что хотите удалить это соревнование?')) {
                state.competitions = state.competitions.filter(c => c.id !== id);
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderCompetitionsList();
                }
            }
        }

        async function addRace() {
            const nameInput = document.getElementById('newRaceName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('Введите название заезда', true);
                return;
            }
            
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const newId = competition.races && competition.races.length > 0 
                ? Math.max(...competition.races.map(r => r.id)) + 1 
                : 1;
            
            if (!competition.races) competition.races = [];
            
            competition.races.push({
                id: newId,
                name: name,
                participants: [],
                completed: false
            });
            
            const success = await saveDataToGitHub(state.competitions);
            if (success) {
                nameInput.value = '';
                renderCompetition();
            }
        }

        async function editRace(id) {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const race = competition.races.find(r => r.id === id);
            const newName = prompt('Введите новое название заезда:', race.name);
            
            if (newName !== null && newName.trim() !== '') {
                race.name = newName.trim();
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderCompetition();
                }
            }
        }

        async function deleteRace(id) {
            if (confirm('Вы уверены, что хотите удалить этот заезд?')) {
                const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
                competition.races = competition.races.filter(r => r.id !== id);
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderCompetition();
                }
            }
        }

        async function addParticipant() {
            const numberInput = document.getElementById('newParticipantNumber');
            const nameInput = document.getElementById('newParticipantName');
            const number = numberInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!number || !name) {
                showNotification('Заполните все поля', true);
                return;
            }
            
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const race = competition.races.find(r => r.id === state.currentRaceId);
            
            if (!race.participants) race.participants = [];
            
            const newId = race.participants.length > 0 
                ? Math.max(...race.participants.map(p => p.id)) + 1 
                : 1;
            
            race.participants.push({
                id: newId,
                number: parseInt(number),
                name: name,
                time: null,
                place: null
            });
            
            const success = await saveDataToGitHub(state.competitions);
            if (success) {
                numberInput.value = '';
                nameInput.value = '';
                renderRace();
            }
        }

        async function editParticipant(id) {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const race = competition.races.find(r => r.id === state.currentRaceId);
            const participant = race.participants.find(p => p.id === id);
            
            const newNumber = prompt('Введите новый номер участника:', participant.number);
            if (newNumber === null) return;
            
            const newName = prompt('Введите новое имя участника:', participant.name);
            if (newName === null) return;
            
            participant.number = parseInt(newNumber);
            participant.name = newName;
            
            const success = await saveDataToGitHub(state.competitions);
            if (success) {
                renderRace();
            }
        }

        async function deleteParticipant(id) {
            if (confirm('Вы уверены, что хотите удалить этого участника?')) {
                const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
                const race = competition.races.find(r => r.id === state.currentRaceId);
                race.participants = race.participants.filter(p => p.id !== id);
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderRace();
                }
            }
        }

        async function completeRace() {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const race = competition.races.find(r => r.id === state.currentRaceId);
            
            let resultsHtml = `
                <h3>Введите результаты заезда</h3>
                <form id="resultsForm">
                    <table>
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Участник</th>
                                <th>Место</th>
                                <th>Время (мм:сс.мм)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            race.participants.forEach(participant => {
                resultsHtml += `
                    <tr>
                        <td>${participant.number}</td>
                        <td>${participant.name}</td>
                        <td>
                            <input type="number" min="1" max="${race.participants.length}" 
                                name="place-${participant.id}" required>
                        </td>
                        <td>
                            <input type="text" name="time-${participant.id}" 
                                placeholder="мм:сс.мм" required pattern="\\d{2}:\\d{2}\\.\\d{2}">
                        </td>
                    </tr>
                `;
            });
            
            resultsHtml += `
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-complete">Сохранить результаты</button>
                </form>
            `;
            
            contentDiv.insertAdjacentHTML('beforeend', resultsHtml);
            
            document.getElementById('resultsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                let hasError = false;
                
                race.participants.forEach(participant => {
                    const placeInput = document.querySelector(`input[name="place-${participant.id}"]`);
                    const timeInput = document.querySelector(`input[name="time-${participant.id}"]`);
                    
                    if (!placeInput.value || !timeInput.value) {
                        hasError = true;
                        return;
                    }
                    
                    participant.place = parseInt(placeInput.value);
                    participant.time = timeInput.value;
                });
                
                if (hasError) {
                    showNotification('Заполните все поля', true);
                    return;
                }
                
                race.completed = true;
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderRace();
                }
            });
        }

        async function editResult(id) {
            const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
            const race = competition.races.find(r => r.id === state.currentRaceId);
            const participant = race.participants.find(p => p.id === id);
            
            const newPlace = prompt('Введите новое место участника:', participant.place);
            if (newPlace === null) return;
            
            const newTime = prompt('Введите новое время участника (мм:сс.мм):', participant.time);
            if (newTime === null) return;
            
            participant.place = parseInt(newPlace);
            participant.time = newTime;
            
            const success = await saveDataToGitHub(state.competitions);
            if (success) {
                renderRace();
            }
        }

        async function reopenRace() {
            if (confirm('Вы уверены, что хотите возобновить заезд? Результаты будут сброшены.')) {
                const competition = state.competitions.find(c => c.id === state.currentCompetitionId);
                const race = competition.races.find(r => r.id === state.currentRaceId);
                
                race.participants.forEach(participant => {
                    participant.place = null;
                    participant.time = null;
                });
                
                race.completed = false;
                const success = await saveDataToGitHub(state.competitions);
                if (success) {
                    renderRace();
                }
            }
        }

        function renderCurrentView() {
            switch (state.currentView) {
                case 'competitions': renderCompetitionsList(); break;
                case 'competition': renderCompetition(); break;
                case 'race': renderRace(); break;
            }
        }

        init();
    </script>
</body>
</html>